<!DOCTYPE html>
<html>
    <head>
        <meta charset='utf-8' />
        <title></title>
        <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
        <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>   
        <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.39.1/mapbox-gl.js'></script>
        <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.39.1/mapbox-gl.css' rel='stylesheet' />
        <link href="https://api.mapbox.com/mapbox-assembly/v0.17.0/assembly.min.css" rel="stylesheet">
        <script async defer src="https://api.mapbox.com/mapbox-assembly/v0.17.0/assembly.js"></script>
        <style>
            body { margin:0; padding:0; }
            #map { position:absolute; top:0; bottom:0; width:100%; }
        </style>
    </head>
    <body>

        <div id='map'></div>
        <div class='absolute p24 m24'>
            <input type='number' name='radius' id='radius-number'>
        </div>

        <div class='map-overlay' id='features'></div>
        <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiY21jZzIiLCJhIjoiY2lxazNsejg0MDE2NWdia3ZmbzNpeWZ4MCJ9.KqUFqt2hTvgrxaBQyP9OqA';
        var map = new mapboxgl.Map({
            container: 'map', // container id
            style: 'mapbox://styles/mapbox/light-v9', //stylesheet location
            center: [-9.177, 6.219], // starting position
            zoom: 6, // starting zoom

        });

        map.on('load', function(){
            map.addControl(new mapboxgl.ScaleControl({
                maxWidth: 80,
                unit: 'imperial'
            }));

            map.addLayer({
                "id": "health-facilities",
                "type": "circle",
                "source": {
                    "type": "vector",
                    "url": "mapbox://cmcg2.358k3iua"
                },
                "source-layer": "health-facilities-ci1yfs",
                "paint": {
                    "circle-color": "#000",
                    "circle-radius": 2
                }
            });

            map.addSource('health-facilities-source', {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: []
                }
            });

            var radiusInput = document.getElementById('radius-number');
            radiusInput.addEventListener('input', function(){
                var facilities = map.queryRenderedFeatures({ layers: ['health-facilities'] });
                var circles = [];
                facilities.forEach(function(facility, e){
                    var center = [facility.geometry.coordinates[0], facility.geometry.coordinates[1]];
                    var radius = radiusInput.value;
                    var steps = 20;
                    var units = 'miles';
                    var circle = turf.circle(center, radius, steps, units);
                    circles.push(circle);
                });

                map.getSource('health-facilities-source').setData({
                  type: 'FeatureCollection',
                  features: circles
                });

                map.addLayer({
                "id": "health-facility-radii",
                "type": "fill",
                "source": 'health-facilities-source',
                "paint": {
                    "fill-color": "rgba(0, 0, 0, 0.2)"
                }
                }, "health-facilities");        
            });
        });

        </script>

    </body>
</html>
